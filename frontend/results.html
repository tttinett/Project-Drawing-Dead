<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ผลการค้นหา | Tasty Bar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/main/img/logo.png">
  <style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700&display=swap');

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'Noto Sans Thai', sans-serif;
}

/* Navbar */
.navbar {
  width: 100%;
  background: #fff;
  padding: 10px 30px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.navbar .logo {
  width: 80px;
}

.navbar ul {
  list-style: none;
  display: flex;
  gap: 25px;
}

.navbar ul li a {
  text-decoration: none;
  color: #000;
  font-weight: 600;
}

.glass-card {
  background: var(--glass-bg);
  border: 1px solid var(--glass-brd);
  border-radius: 1.25rem;
  box-shadow: 0 10px 35px rgba(0,0,0,.25);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
.btn-brand {
  color: #fff;
  background:#a51212;
  border-color:#a51212;
}
.btn-brand:hover {
  background:#8f0f0f;
  border-color:#8f0f0f;
}
.result-item {
  border:1px solid rgba(0,0,0,.15);
  border-radius:.75rem;
  padding:1rem;
  position:relative;
  background:#fff;
}
.close-line {
  position:absolute;
  right:.5rem;
  top:.5rem;
  border:none;
  background:transparent;
  font-size:1.1rem;
  line-height:1;
  opacity:.65;
}
.close-line:hover { opacity:1 }
main {
  padding-top:min(7vh,48px);
  padding-bottom:min(7vh,48px);
}
.logo-pill {
  width:46px;
  height:46px;
  border-radius:50%;
  display:grid;
  place-items:center;
  font-weight:700;
  background:#000;
  color:#ffd54d;
  box-shadow:0 2px 8px rgba(0,0,0,.35);
}
  </style>
</head>
<body>

  <div class="navbar">
    <img src="/img/logo.png" alt="logo" class="logo">
    <ul>
      <li><a href="/login.html">เข้าสู่ระบบ</a></li>
      <li><a href="/main.html">หน้าหลัก</a></li>
      <li><a href="/notifications.html">แจ้งเตือน</a></li>
      <li><a href="/contact.html">ติดต่อเรา</a></li>
    </ul>
  </div>

  <main class="d-flex justify-content-center">
    <div class="container">
      <div class="glass-card p-4 p-sm-5 mx-auto" style="max-width:980px">
        <h1 class="h5 fw-bold mb-3">ผลการค้นหา</h1>
        <p class="mb-4 text-secondary" id="criteriaText">—</p>

        <!-- ตารางผลลัพธ์ -->
        <div class="table-responsive mb-3">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th style="width:60%">ชื่อ</th>
                <th style="width:25%">วัน/เดือน/ปี</th>
                <th style="width:15%" class="text-end">ดำเนินการ</th>
              </tr>
            </thead>
            <tbody id="resultTableBody">
              <!-- แทรกด้วย JS -->
            </tbody>
          </table>
        </div>

        <!-- ถ้าไม่พบ -->
        <div id="emptyState" class="alert alert-warning d-none rounded-3">
          ไม่พบข้อมูลการจองตามเงื่อนไขที่ระบุ
        </div>

        <!-- ปุ่มกลับ -->
        <div class="d-flex gap-2 mt-4">
          <a href="/manage.html" class="btn btn-outline-dark rounded-3">กลับไปค้นหา</a>
        </div>
      </div>
    </div>
  </main>

  <footer class="text-center text-white-50 small py-4">
    © <span id="y"></span> Tasty Bar
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="/js/api.js"></script>
<script>
const params = new URLSearchParams(location.search);
const qName  = (params.get('name')  || '').trim();
const qPhone = (params.get('phone') || '').trim();
document.getElementById('criteriaText').textContent =
  `คำค้นหา — ชื่อ: "${qName || '-'}" · เบอร์โทร: "${qPhone || '-'}"`;

const tbody = document.getElementById('resultTableBody');
const empty = document.getElementById('emptyState');

// ---- helpers ----
function tableNumber(value) {
  const raw = (value ?? '').toString().trim();
  if (!raw) return '-';
  // ตัด "โต๊ะ" ด้านหน้า ถ้ามี
  return raw.replace(/^โต๊ะ\s*/i, '');
}
function onlyDate(v) {
  if (!v) return '-';
  const s = v.toString();
  // ถ้าเป็น ISO (มี T) ตัดหน้า T
  if (s.includes('T')) return s.split('T')[0];
  // ถ้าเป็น Date object
  if (v instanceof Date && !isNaN(v)) {
    const y = v.getFullYear();
    const m = String(v.getMonth()+1).padStart(2,'0');
    const d = String(v.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  // กรณีส่งมาเป็น 'YYYY-MM-DD' อยู่แล้ว
  return s;
}

function rowEl(r){
  const tr = document.createElement('tr');

  // รองรับหลายชื่อฟิลด์จาก API
  const tableText = r.table ?? r.table_name ?? '-';
  const dateRaw   = r.date ?? r.reserve_date ?? r.date_time ?? r.start_dt ?? '-';
  const dateTxt   = onlyDate(dateRaw);
  const tnum      = tableNumber(tableText);
  const phone     = r.phone ?? '-';

  tr.innerHTML = `
    <td>
      <div class="result-item">
        <button class="close-line" title="ลบรายการ" aria-label="ลบ">×</button>
        <div class="small text-secondary mb-1">ชื่อผู้จอง</div>
        <div class="fw-semibold">${r.name ?? '-'}</div>

        <div class="mt-2 d-flex flex-wrap gap-2">
          <span class="badge text-bg-dark rounded-pill px-3 py-2">โต๊ะ ${tnum}</span>
          <span class="badge text-bg-secondary rounded-pill px-3 py-2">${phone}</span>
        </div>

        <div class="mt-3">
          <a href="reservation-detail.html?id=${encodeURIComponent(r.id)}"
             class="btn btn-sm btn-outline-secondary rounded-3">ดูข้อมูลเพิ่มเติม</a>
        </div>
      </div>
    </td>
    <td>${dateTxt}</td>
    <td class="text-end">
      <a href="reservation-detail.html?id=${encodeURIComponent(r.id)}"
         class="btn btn-sm btn-brand rounded-3">เปิด</a>
    </td>`;
  tr.querySelector('.close-line').onclick = ()=>{
    tr.remove();
    if(!tbody.children.length) empty.classList.remove('d-none');
  };
  return tr;
}

document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    const items = await API.search({ name: qName, phone: qPhone });
    tbody.innerHTML = "";
    if(!items.length){ empty.classList.remove('d-none'); return; }
    empty.classList.add('d-none');
    items.forEach(r => tbody.appendChild(rowEl(r)));
  }catch(err){
    tbody.innerHTML = `<tr><td colspan="3"><div class="alert alert-danger">ค้นหาไม่สำเร็จ: ${err.message}</div></td></tr>`;
    empty.classList.add('d-none');
  }
});
</script>

</body>
</html>
