<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>การแจ้งเตือน | Tasty Bar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/img/logo.png" />
  <link rel="stylesheet" href="/css/notifications.css">
</head>
<body>

  <div class="navbar">
    <img src="/img/logo.png" alt="logo" class="logo">
    <ul>
      <li><a href="/login.html">เข้าสู่ระบบ</a></li>
      <li><a href="/main.html">หน้าหลัก</a></li>
      <li><a href="/notifications.html" class="active">แจ้งเตือน</a></li>
      <li><a href="/contact.html">ติดต่อเรา</a></li>
      <li><button class="btn btn-sm btn-danger" onclick="logout()">ออกจากระบบ</button></li>
    </ul>
  </div>

  <main>
    <div class="glass-card">
      <div class="section-head">การแจ้งเตือน</div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="text-secondary fw-semibold">รายการล่าสุด</div>
        <select id="filter" class="form-select form-select-sm" style="width:auto">
          <option value="pending" selected>เฉพาะรอดำเนินการ</option>
          <option value="all">ทั้งหมด</option>
          <option value="confirmed">ยืนยันแล้ว</option>
          <option value="canceled">ยกเลิกแล้ว</option>
        </select>
      </div>

      <div id="loading" class="alert alert-secondary d-none">กำลังโหลด...</div>
      <div id="list" class="vstack gap-3"></div>
      <div id="empty" class="alert alert-light border text-center d-none mt-3">ไม่มีรายการตามตัวกรอง</div>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const user = JSON.parse(localStorage.getItem("authUser") || "null");
      if (!user || user.shopName !== "TongEiw") {
        alert("เฉพาะเจ้าของร้านเท่านั้นที่สามารถเข้าหน้านี้ได้");
        window.location.href = "/login.html";
      }
    });

    function logout() {
      localStorage.removeItem("authUser");
      alert("ออกจากระบบเรียบร้อยแล้ว");
      window.location.href = "/login.html";
    }
  </script>

  <script>
  const $ = (s)=>document.querySelector(s);
  const list = $("#list");
  const empty = $("#empty");
  const filterEl = $("#filter");
  const loading = $("#loading");

  // helper: ตัดเวลาออก (รองรับทั้ง string และ null/undefined)
  const dateOnly = x => (x ?? '').toString().split('T')[0] || x || '-';

  async function fetchAll() {
    const res = await fetch("/api/reservations");
    if(!res.ok) throw new Error("โหลดข้อมูลไม่สำเร็จ");
    const rows = await res.json();

    // ทำให้ field เป็นมาตรฐาน เผื่อ backend คืน table_name แทน table
    return rows.map(r => ({
      ...r,
      table: r.table ?? r.table_name ?? '-',   // ✅ รองรับทั้งสองฟิลด์
      date:  dateOnly(r.date)                  // ✅ ตัดเวลาออกเลย
    }));
  }

  function filtered(items, mode){
    if(mode==="all") return items;
    return items.filter(x=>x.status===mode);
  }

  function statusText(s){
    return s==="pending"?"รอดำเนินการ":(s==="confirmed"?"ยืนยันแล้ว":"ยกเลิกแล้ว");
  }
  function tableNumber(val) {
  return (val ?? '').toString().trim().replace(/^โต๊ะ\s*/i, '');
  }

  async function render(){
    list.innerHTML = "";
    loading.classList.remove("d-none");
    const mode = filterEl.value || "pending";
    try{
      const items = filtered(await fetchAll(), mode);
      empty.classList.toggle("d-none", items.length>0);

      for(const r of items){
        const row = document.createElement("div");
        row.className = "notif-item";
        row.dataset.id = r.id;

        const disabledAttr = (r.status !== "pending") ? "disabled" : "";

        row.innerHTML = `
          <div class="notif-left">
            <div class="notif-icon"><i class="bi bi-bell-fill"></i></div>
            <div>
              <div class="fw-bold">${statusText(r.status)}</div>
              <div class="text-secondary small">โต๊ะ ${tableNumber(r.table)} • ${r.date} • ${r.name}</div>
            </div>
          </div>
          <div class="notif-actions">
            <button class="btn btn-danger btn-cancel" ${disabledAttr}>ยกเลิก</button>
            <button class="btn btn-success btn-approve" ${disabledAttr}>ตกลง</button>
            ${ r.status === "canceled" ? `<button class="btn btn-secondary btn-restore">กู้คืน</button>` : `` }
          </div>
        `;

        const btnApprove = row.querySelector(".btn-approve");
        const btnCancel  = row.querySelector(".btn-cancel");
        const btnRestore = row.querySelector(".btn-restore");

        row.querySelector(".notif-left").addEventListener("click", ()=>{
          window.location.href = `/reservation-detail.html?id=${encodeURIComponent(r.id)}`;
        });

        const lock = (btns, on=true)=>btns.forEach(b=>b && (b.disabled = on || b.hasAttribute("disabled")));

        btnApprove?.addEventListener("click", async (e)=>{
          e.preventDefault(); e.stopPropagation();
          if(r.status!=="pending") return alert("รายการนี้ไม่สามารถยืนยันได้แล้ว");
          lock([btnApprove, btnCancel], true);
          const res = await fetch(`/api/reservations/${encodeURIComponent(r.id)}/confirm`, {method:"POST"});
          if(!res.ok) alert("ยืนยันไม่สำเร็จ");
          render();
        });

        btnCancel?.addEventListener("click", async (e)=>{
          e.preventDefault(); e.stopPropagation();
          if(r.status!=="pending") return alert("รายการนี้ไม่สามารถยกเลิกได้แล้ว");
          const reason = prompt("ระบุเหตุผลการยกเลิก","เช่น ลูกค้าไม่มา / เปลี่ยนวันจอง");
          if(reason===null) return;
          lock([btnApprove, btnCancel], true);
          const res = await fetch(`/api/reservations/${encodeURIComponent(r.id)}/cancel`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ reason })
          });
          if(!res.ok) alert("ยกเลิกไม่สำเร็จ");
          render();
        });

        btnRestore?.addEventListener("click", async (e)=>{
          e.preventDefault(); e.stopPropagation();
          lock([btnRestore], true);
          const res = await fetch(`/api/reservations/${encodeURIComponent(r.id)}/restore`, {method:"POST"});
          if(!res.ok) alert("กู้คืนไม่สำเร็จ");
          filterEl.value = "pending";
          render();
        });

        list.appendChild(row);
      }
    }catch(err){
      list.innerHTML = `<div class="alert alert-danger">โหลดข้อมูลไม่สำเร็จ: ${err.message}</div>`;
      empty.classList.add("d-none");
    }finally{
      loading.classList.add("d-none");
    }
  }

  filterEl.addEventListener("change", render);
  document.addEventListener("DOMContentLoaded", render);
</script>

</body>
</html>
